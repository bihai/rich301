#{extends 'main.html' /}
#{set title:messages.get("game.title") /}

<div id="players">
<ul>
    #{list items: game.players, as: "player"}
    <li>${player.name}</li>
    #{/list}
</ul>
</div>
<div id="game">
HERE IS GAME
</div>


<script type="text/javascript">
// Handle events
var gameId = "${game.id}";
(function($, window) {
	
    var playList = [];
	    
	R301.module.Action.init(function(events, textStatus) {
		
		console.log(events);
		
		var data = events[0].data.game,
			players = data.players,
			gameMap = data.gameMap,
			i = 0, len = players.length,
			x = 0, y = 0, player = null,
			avatarPath = R301.constants.PUBLIC_PATH + '/data/roles/',
			game = new R301.module.Game({
				background: background,
				map: gameMap.mapCells
			});
	    
		for(i; i < len; i++) {
			player = players[i];
			
			x = parseInt(player.currentCellId / gameMap.height);
			y = player.currentCellId % gameMap.height;
			
			var p = new R301.module.Player({
				avatar: avatarPath + player.role.face,
				width: 128, 
				height: 128,
				x: x,
				y: y
			});
			
			playList.push(p);
			game.registAction(function() {
				game.draw(p.getPlayer(), x * cellWidth, y * cellHeight);
			});
		};
		
		game.init();
		game.appendTo(document.body);
	    game.run();
	});
    
})(jQuery, window);
</script>















