#{extends 'main.html' /}
#{set title:messages.get("game.title") /}

<div id="players">
<ul>
    #{list items: game.players, as: "player"}
    <li>${player.name}</li>
    #{/list}
</ul>
</div>
<div id="game">
HERE IS GAME
</div>


<script type="text/javascript">
// Handle events
var gameId = "${game.id}";
(function($, window) {
    var lastReceived = 0;
    var waitEvents = #{jsAction @Games.waitEvents(game.name, ":lastReceived") /}
    var getEvents = function() {
        $.ajax({
            url: waitEvents({ lastReceived: lastReceived }),
            contentType: "application/json",
            success: function(events, textStatus) {
                console.log(events);
                lastReceived = events[0].id;
                getEvents();
            },
            error: function(request, textStatus, error) {
                console.log(textStatus, error);
            }
        });
    };
    getEvents();

    //begin xiexie
    var rich = new R301.module.Game({
		background: background,
		map: map
	});
	
	rich.appendTo(document.body);
	rich.run();
	
	var shasha = new R301.module.Player({
		avatar: R301.constants.PUBLIC_PATH + '/data/roles/role_shasha.png',
		height: 48
	});
	
	R301.module.Action.init();
    
})(jQuery, window);
</script>